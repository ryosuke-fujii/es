<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESåˆæ ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>

    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --accent-blue: #2563eb;
            --accent-blue-hover: #1d4ed8;
            --accent-blue-light: #dbeafe;
        }
        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px 0;
        }
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 40px;
        }
        .page-title {
            text-align: center;
            color: var(--accent-blue);
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: bold;
        }
        .page-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
        }
        .required {
            color: #666;
        }
        .es-questions-area {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            background: #fafafa;
        }
        .es-question-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .es-question-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .char-count {
            text-align: right;
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .btn-primary {
            background: var(--accent-blue);
            border: none;
            color: white;
        }
        .btn-primary:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
            border: none;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: #666;
            border: none;
        }
        .btn-success:hover {
            background: #555;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--accent-blue);
        }
        .company-card {
            border-left: 3px solid var(--accent-blue);
            transition: transform 0.2s;
        }
        .company-card:hover {
            transform: translateX(3px);
        }
        .match-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        .es-sample-card {
            border-left: 3px solid #666;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        .badge-pass {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .badge-accepted {
            background-color: var(--accent-blue-light);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
        }
        .target-company-match {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .target-company-item {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #e0e0e0;
        }
        .target-company-item.first-choice {
            border-left: 3px solid var(--accent-blue);
        }
        .target-company-item.second-choice {
            border-left: 3px solid #666;
        }
        .target-company-item.third-choice {
            border-left: 3px solid #999;
        }
        .alert {
            border-radius: 4px;
            border-width: 1px;
        }
        .alert-info {
            background-color: var(--accent-blue-light);
            border-color: var(--accent-blue);
            color: #1e40af;
        }
        .alert-warning {
            background-color: #fff9e6;
            border-color: #e0d7b0;
            color: #666;
        }
        .alert-secondary {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #495057;
        }
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .text-primary {
            color: var(--accent-blue) !important;
        }
        .card-title {
            color: var(--accent-blue);
        }
        select option {
            padding-right: 10px;
        }
        .btn-outline-primary {
            color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        .btn-outline-primary:hover {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .collapse {
            transition: height 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 class="page-title">ESåˆæ ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p class="page-subtitle">3.5ä¸‡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç²¾å¯†åˆ†æ</p>

            <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="form-section">
                <form id="diagnosis-form">
                    <!-- å¤§å­¦å -->
                    <div class="mb-3">
                        <label for="university" class="form-label">
                            <i class="bi bi-mortarboard-fill"></i> å¤§å­¦å<span class="required">*</span>
                        </label>
                        <input type="text" class="form-control" id="university" list="universities-list"
                               required placeholder="å¤§å­¦åã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ">
                        <datalist id="universities-list"></datalist>
                        <small class="text-muted">å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                    </div>

                    <!-- å­¦éƒ¨ãƒ»å­¦ç§‘ -->
                    <div class="mb-3">
                        <label for="major" class="form-label">
                            <i class="bi bi-book-fill"></i> å­¦éƒ¨ãƒ»å­¦ç§‘
                        </label>
                        <input type="text" class="form-control" id="major"
                               placeholder="ä¾‹: ç†å·¥å­¦éƒ¨ æƒ…å ±å·¥å­¦ç§‘">
                    </div>

                    <!-- å’æ¥­å¹´åº¦ -->
                    <div class="mb-3">
                        <label for="graduationYear" class="form-label">
                            <i class="bi bi-calendar-fill"></i> å’æ¥­å¹´åº¦<span class="required">*</span>
                        </label>
                        <select class="form-select" id="graduationYear" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="25">25å’</option>
                            <option value="26">26å’</option>
                            <option value="27">27å’</option>
                            <option value="28">28å’</option>
                        </select>
                    </div>

                    <!-- å¿—æœ›æ¥­ç•Œ -->
                    <div class="mb-3">
                        <label for="targetIndustry" class="form-label">
                            <i class="bi bi-briefcase-fill"></i> å¿—æœ›æ¥­ç•Œ<span class="required">*</span>
                        </label>
                        <select class="form-select" id="targetIndustry" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                        <small class="text-muted" id="industry-count"></small>
                    </div>

                    <!-- ç¬¬ä¸€å¿—æœ›ä¼æ¥­ -->
                    <div class="mb-3">
                        <label for="targetCompany1" class="form-label">
                            <i class="bi bi-trophy-fill text-warning"></i> ç¬¬ä¸€å¿—æœ›ä¼æ¥­ï¼ˆä»»æ„ï¼‰
                        </label>
                        <input type="text" class="form-control" id="targetCompany1"
                               list="companies-list" placeholder="ä¼æ¥­åã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ">
                        <datalist id="companies-list"></datalist>
                        <small class="text-muted">å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæ¥­ç•Œã‚‚è¡¨ç¤ºï¼‰</small>
                    </div>

                    <!-- ç¬¬äºŒå¿—æœ›ä¼æ¥­ -->
                    <div class="mb-3">
                        <label for="targetCompany2" class="form-label">
                            <i class="bi bi-trophy text-secondary"></i> ç¬¬äºŒå¿—æœ›ä¼æ¥­ï¼ˆä»»æ„ï¼‰
                        </label>
                        <input type="text" class="form-control" id="targetCompany2"
                               list="companies-list" placeholder="ä¼æ¥­åã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ">
                        <small class="text-muted">å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæ¥­ç•Œã‚‚è¡¨ç¤ºï¼‰</small>
                    </div>

                    <!-- ç¬¬ä¸‰å¿—æœ›ä¼æ¥­ -->
                    <div class="mb-3">
                        <label for="targetCompany3" class="form-label">
                            <i class="bi bi-trophy" style="color: #cd7f32;"></i> ç¬¬ä¸‰å¿—æœ›ä¼æ¥­ï¼ˆä»»æ„ï¼‰
                        </label>
                        <input type="text" class="form-control" id="targetCompany3"
                               list="companies-list" placeholder="ä¼æ¥­åã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠ">
                        <small class="text-muted">å…¥åŠ›ã™ã‚‹ã¨å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæ¥­ç•Œã‚‚è¡¨ç¤ºï¼‰</small>
                    </div>

                    <!-- ESè³ªå•ã¨å›ç­” -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-pencil-square"></i> ESè³ªå•ã¨å›ç­”<span class="required">*</span>
                        </label>
                        <div class="es-questions-area" id="es-questions-container">
                            <div class="es-question-item">
                                <label class="form-label">è³ªå•1</label>
                                <select class="form-select es-question-select mb-2" required>
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                </select>
                                <textarea class="form-control es-answer" rows="4" required
                                          placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ100æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰"></textarea>
                                <div class="char-count"><span class="answer-count">0</span>æ–‡å­—</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-sm mt-2" onclick="addQuestion()">
                            <i class="bi bi-plus-circle"></i> è³ªå•ã‚’è¿½åŠ 
                        </button>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100" id="submit-btn">
                        <i class="bi bi-search"></i> è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹
                    </button>
                </form>
            </div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="loading" class="text-center d-none py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>è¨ºæ–­ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
            </div>

            <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="results" class="d-none">
                <!-- å¿—æœ›ä¼æ¥­ã®ãƒãƒƒãƒç‡ -->
                <div id="target-companies-section" class="d-none">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="card-title h4 text-primary mb-3">
                                <i class="bi bi-heart-fill"></i> å¿—æœ›ä¼æ¥­ã¨ã®ãƒãƒƒãƒç‡
                            </h2>
                            <div id="target-companies-result"></div>
                        </div>
                    </div>
                </div>

                <!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title h4 text-primary mb-3">
                            <i class="bi bi-bar-chart-fill"></i> è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼
                        </h2>
                        <div class="row" id="summary-stats"></div>
                    </div>
                </div>

                <!-- TOP5ä¼æ¥­ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title h4 text-primary mb-3">
                            <i class="bi bi-building"></i> ã‚ãªãŸãŒå—ã‹ã‚Šã‚„ã™ã„ä¼æ¥­ TOP5
                        </h2>
                        <div id="companies-result"></div>
                    </div>
                </div>

                <!-- æ¥­ç•Œåˆ†æ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title h4 text-primary mb-3">
                            <i class="bi bi-graph-up"></i> æ¥­ç•Œåˆ†æ
                        </h2>
                        <div class="row mb-3" id="industry-stats"></div>
                        <div class="alert alert-warning" id="recommendations"></div>

                        <!-- æ¥­ç•Œå†…ã®é¡ä¼¼ES -->
                        <div id="industry-similar-es-section" class="mt-4"></div>
                    </div>
                </div>

                <!-- ESåˆ†æ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h2 class="card-title h4 text-primary mb-3">
                            <i class="bi bi-pencil-square"></i> ESåˆ†æ
                        </h2>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title text-success">
                                            <i class="bi bi-check-circle"></i> è‰¯ã„ç‚¹
                                        </h5>
                                        <ul id="strengths-list" class="list-unstyled"></ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title text-warning">
                                            <i class="bi bi-exclamation-triangle"></i> æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
                                        </h5>
                                        <ul id="improvements-list" class="list-unstyled"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary w-100" onclick="resetForm()">
                    <i class="bi bi-arrow-counterclockwise"></i> ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let questionCount = 1;
        let universities = [];
        let industries = [];
        let companies = [];
        let commonQuestions = [];
        let companyCounts = {};
        let industryCounts = {};
        let companyIndustries = {};

        function initializeSelects() {
            console.log('ğŸ“‹ é¸æŠè‚¢ã‚’åˆæœŸåŒ–ä¸­...');

            try {
                const dataElement = document.getElementById('embedded-data');
                if (!dataElement) {
                    console.error('âŒ embedded-dataè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                window.EMBEDDED_DATA = JSON.parse(dataElement.textContent);

                universities = window.EMBEDDED_DATA.universities || [];
                industries = window.EMBEDDED_DATA.industries || [];
                companies = window.EMBEDDED_DATA.companies || [];
                commonQuestions = window.EMBEDDED_DATA.commonQuestions || [];
                companyCounts = window.EMBEDDED_DATA.companyCounts || {};
                industryCounts = window.EMBEDDED_DATA.industryCounts || {};
                companyIndustries = window.EMBEDDED_DATA.companyIndustries || {};

                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: å¤§å­¦${universities.length}æ ¡, æ¥­ç•Œ${industries.length}ç¨®é¡, ä¼æ¥­${companies.length}ç¤¾`);

                // å¤§å­¦åã®datalist
                const universitiesList = document.getElementById('universities-list');
                universities.forEach(uni => {
                    const option = document.createElement('option');
                    option.value = uni;
                    universitiesList.appendChild(option);
                });

                // æ¥­ç•Œã®selectï¼ˆãƒ‡ãƒ¼ã‚¿æ•°ä»˜ãï¼‰
                const industrySelect = document.getElementById('targetIndustry');
                industries.forEach(ind => {
                    const option = document.createElement('option');
                    option.value = ind;
                    const count = industryCounts[ind] || 0;
                    option.textContent = `${ind} (${count}ä»¶)`;
                    industrySelect.appendChild(option);
                });

                // ä¼æ¥­åã®datalistï¼ˆæ¥­ç•Œè¡¨ç¤ºï¼‰
                const companiesList = document.getElementById('companies-list');
                companies.forEach(comp => {
                    const option = document.createElement('option');
                    const industry = companyIndustries[comp] || 'ä¸æ˜';
                    option.value = comp;
                    option.textContent = `${comp} (${industry})`;
                    companiesList.appendChild(option);
                });

                // ESè³ªå•ã®select
                updateQuestionSelects();

                console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            } catch (e) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        function updateQuestionSelects() {
            document.querySelectorAll('.es-question-select').forEach(select => {
                if (select.options.length <= 1) {
                    commonQuestions.forEach(q => {
                        const option = document.createElement('option');
                        option.value = q;
                        option.textContent = q;
                        select.appendChild(option);
                    });
                }
            });
        }

        function addQuestion() {
            if (questionCount >= 3) {
                alert('è³ªå•ã¯æœ€å¤§3ã¤ã¾ã§ã§ã™');
                return;
            }

            questionCount++;
            const container = document.getElementById('es-questions-container');
            const newQuestion = document.createElement('div');
            newQuestion.className = 'es-question-item';
            newQuestion.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">è³ªå•${questionCount}</label>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)">
                        <i class="bi bi-trash"></i> å‰Šé™¤
                    </button>
                </div>
                <select class="form-select es-question-select mb-2" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <textarea class="form-control es-answer" rows="4" required placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <div class="char-count"><span class="answer-count">0</span>æ–‡å­—</div>
            `;
            container.appendChild(newQuestion);
            updateQuestionSelects();

            newQuestion.querySelector('.es-answer').addEventListener('input', function(e) {
                const countSpan = e.target.parentElement.querySelector('.answer-count');
                countSpan.textContent = e.target.value.length;
            });
        }

        function removeQuestion(btn) {
            btn.closest('.es-question-item').remove();
            questionCount--;
        }

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('es-answer')) {
                const countSpan = e.target.parentElement.querySelector('.answer-count');
                countSpan.textContent = e.target.value.length;
            }
        });

        document.getElementById('diagnosis-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const esQuestions = [];
            const esAnswers = [];

            document.querySelectorAll('.es-question-item').forEach(item => {
                const question = item.querySelector('.es-question-select').value;
                const answer = item.querySelector('.es-answer').value;
                if (question && answer) {
                    esQuestions.push(question);
                    esAnswers.push(answer);
                }
            });

            const hasLongAnswer = esAnswers.some(a => a.length >= 100);
            if (!hasLongAnswer) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®å›ç­”ã¯100æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const formData = {
                university: document.getElementById('university').value,
                major: document.getElementById('major').value,
                graduationYear: document.getElementById('graduationYear').value,
                targetIndustry: document.getElementById('targetIndustry').value,
                targetCompanies: [
                    document.getElementById('targetCompany1').value,
                    document.getElementById('targetCompany2').value,
                    document.getElementById('targetCompany3').value
                ].filter(c => c && c.trim() !== ''),
                esQuestions: esQuestions,
                esAnswers: esAnswers
            };

            document.getElementById('form-section').classList.add('d-none');
            document.getElementById('loading').classList.remove('d-none');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                displayResults(result);
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('form-section').classList.remove('d-none');
                document.getElementById('loading').classList.add('d-none');
            }
        });

        function displayResults(data) {
            console.log('ğŸ“Š è¨ºæ–­çµæœã‚’è¡¨ç¤ºä¸­:', data);

            if (!data.matchCompanies || data.matchCompanies.length === 0) {
                console.error('âŒ matchCompaniesãŒç©ºã§ã™');
                alert('ãƒãƒƒãƒã™ã‚‹ä¼æ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                document.getElementById('form-section').classList.remove('d-none');
                document.getElementById('loading').classList.add('d-none');
                return;
            }

            console.log(`âœ… ${data.matchCompanies.length}ç¤¾ã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡`);

            // å¿—æœ›ä¼æ¥­ã®ãƒãƒƒãƒç‡è¡¨ç¤º
            if (data.targetCompaniesMatch && data.targetCompaniesMatch.length > 0) {
                document.getElementById('target-companies-section').classList.remove('d-none');

                const targetCompaniesHtml = data.targetCompaniesMatch.map((target, index) => {
                    const choiceClass = index === 0 ? 'first-choice' : (index === 1 ? 'second-choice' : 'third-choice');
                    const choiceIcon = index === 0 ? '<i class="bi bi-trophy-fill text-warning"></i>' :
                                      (index === 1 ? '<i class="bi bi-trophy text-secondary"></i>' :
                                       '<i class="bi bi-trophy" style="color: #cd7f32;"></i>');
                    const choiceLabel = index === 0 ? 'ç¬¬ä¸€å¿—æœ›' : (index === 1 ? 'ç¬¬äºŒå¿—æœ›' : 'ç¬¬ä¸‰å¿—æœ›');

                    // ESã‚µãƒ³ãƒ—ãƒ«ã®HTMLã‚’ç”Ÿæˆ
                    let esSamplesHtml = '';
                    if (target.esSamples && target.esSamples.length > 0) {
                        const samplesContent = target.esSamples.map(sample => {
                            const badgeClass = sample.result === 'å†…å®š' ? 'badge-accepted' : 'badge-pass';
                            const badgeText = sample.result === 'å†…å®š' ? 'å†…å®š' : 'é€šé';

                            const qaItemsHtml = sample.esContent.map(qa => `
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="text-primary"><i class="bi bi-question-circle"></i> ${qa.question}</h6>
                                        <p class="card-text" style="white-space: pre-wrap;">${qa.answer}</p>
                                    </div>
                                </div>
                            `).join('');

                            return `
                                <div class="card es-sample-card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="card-title mb-0">${sample.company}</h6>
                                            <span class="badge ${badgeClass}">${badgeText}</span>
                                        </div>
                                        <div class="alert alert-secondary py-2 mb-3">
                                            <small>
                                                <i class="bi bi-mortarboard"></i> ${sample.profile.university} |
                                                <i class="bi bi-book"></i> ${sample.profile.major} |
                                                <i class="bi bi-percent"></i> é¡ä¼¼åº¦: ${sample.similarity}%
                                            </small>
                                        </div>
                                        ${qaItemsHtml}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        esSamplesHtml = `
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#target-es-${index}">
                                    <i class="bi bi-file-earmark-text"></i> é¡ä¼¼ESã‚’è¦‹ã‚‹ (${target.esSamples.length}ä»¶)
                                </button>
                                <div class="collapse mt-3" id="target-es-${index}">
                                    ${samplesContent}
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="target-company-item ${choiceClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">${choiceIcon} ${choiceLabel}: ${target.name}</h5>
                                    <small class="text-muted">${target.industry || 'æ¥­ç•Œä¸æ˜'}</small>
                                </div>
                                <div class="text-end">
                                    <div class="match-score">${target.matchScore}%</div>
                                    <small class="text-muted">ãƒãƒƒãƒç‡</small>
                                </div>
                            </div>
                            ${target.reason ? `<div class="mt-2"><small><i class="bi bi-info-circle"></i> ${target.reason}</small></div>` : ''}
                            ${esSamplesHtml}
                        </div>
                    `;
                }).join('');

                document.getElementById('target-companies-result').innerHTML = targetCompaniesHtml;
            }

            // ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
            const topCompany = data.matchCompanies[0];
            document.getElementById('summary-stats').innerHTML = `
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${topCompany.matchScore}%</div>
                            <div class="text-muted">æœ€é«˜ãƒãƒƒãƒåº¦</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${data.industryAnalysis.passRate}%</div>
                            <div class="text-muted">æ¥­ç•Œåˆæ ¼ç‡</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${data.matchCompanies.length}</div>
                            <div class="text-muted">ãƒãƒƒãƒä¼æ¥­æ•°</div>
                        </div>
                    </div>
                </div>
            `;

            // TOP5ä¼æ¥­
            const companiesHtml = data.matchCompanies.map((company, index) => {
                // ESã‚µãƒ³ãƒ—ãƒ«ã®HTMLã‚’ç”Ÿæˆ
                let esSamplesHtml = '';
                if (company.esSamples && company.esSamples.length > 0) {
                    const samplesContent = company.esSamples.map(sample => {
                        const badgeClass = sample.result === 'å†…å®š' ? 'badge-accepted' : 'badge-pass';
                        const badgeText = sample.result === 'å†…å®š' ? 'å†…å®š' : 'é€šé';

                        const qaItemsHtml = sample.esContent.map(qa => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6 class="text-primary"><i class="bi bi-question-circle"></i> ${qa.question}</h6>
                                    <p class="card-text" style="white-space: pre-wrap;">${qa.answer}</p>
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div class="card es-sample-card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="card-title mb-0">${sample.company}</h6>
                                        <span class="badge ${badgeClass}">${badgeText}</span>
                                    </div>
                                    <div class="alert alert-secondary py-2 mb-3">
                                        <small>
                                            <i class="bi bi-mortarboard"></i> ${sample.profile.university} |
                                            <i class="bi bi-book"></i> ${sample.profile.major} |
                                            <i class="bi bi-percent"></i> é¡ä¼¼åº¦: ${sample.similarity}%
                                        </small>
                                    </div>
                                    ${qaItemsHtml}
                                </div>
                            </div>
                        `;
                    }).join('');

                    esSamplesHtml = `
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#company-es-${index}">
                                <i class="bi bi-file-earmark-text"></i> é¡ä¼¼ESã‚’è¦‹ã‚‹ (${company.esSamples.length}ä»¶)
                            </button>
                            <div class="collapse mt-3" id="company-es-${index}">
                                ${samplesContent}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="card company-card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">#${index + 1} ${company.name}</h5>
                                    <p class="card-text text-muted mb-2">${company.industry}</p>
                                    <div class="alert alert-info mb-0 py-2">
                                        <small><i class="bi bi-lightbulb"></i> ${company.reason}</small>
                                    </div>
                                </div>
                                <div class="text-end ms-3">
                                    <div class="match-score">${company.matchScore}%</div>
                                </div>
                            </div>
                            ${esSamplesHtml}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('companies-result').innerHTML = companiesHtml;

            // æ¥­ç•Œåˆ†æ
            document.getElementById('industry-stats').innerHTML = `
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${data.industryAnalysis.passRate}%</div>
                            <div class="text-muted">åˆæ ¼ç‡</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${data.industryAnalysis.avgApplicants}</div>
                            <div class="text-muted">å¹³å‡å¿œå‹Ÿè€…æ•°</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-value">${data.industryAnalysis.competition}</div>
                            <div class="text-muted">ç«¶äº‰ç‡</div>
                        </div>
                    </div>
                </div>
            `;

            const recommendationsHtml = data.industryAnalysis.recommendations.map(rec =>
                `<li><i class="bi bi-check2"></i> ${rec}</li>`
            ).join('');
            document.getElementById('recommendations').innerHTML = `
                <h5><i class="bi bi-lightbulb-fill"></i> åˆæ ¼å¯èƒ½æ€§ã‚’é«˜ã‚ã‚‹å¯¾ç­–</h5>
                <ul class="mb-0">${recommendationsHtml}</ul>
            `;

            // æ¥­ç•Œå†…ã®é¡ä¼¼ES
            if (data.industrySimilarESSamples && data.industrySimilarESSamples.samples && data.industrySimilarESSamples.samples.length > 0) {
                const industrySimilarESHtml = data.industrySimilarESSamples.samples.map(sample => {
                    const badgeClass = sample.result === 'å†…å®š' ? 'badge-accepted' : 'badge-pass';
                    const badgeText = sample.result === 'å†…å®š' ? 'å†…å®š' : 'é€šé';

                    const qaItemsHtml = sample.esContent.slice(0, 1).map(qa => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="text-primary"><i class="bi bi-question-circle"></i> ${qa.question}</h6>
                                <p class="card-text" style="white-space: pre-wrap;">${qa.answer}</p>
                            </div>
                        </div>
                    `).join('');

                    return `
                        <div class="card es-sample-card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-title mb-0">${sample.company}</h6>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <div class="alert alert-secondary py-2 mb-2">
                                    <small>
                                        <i class="bi bi-mortarboard"></i> ${sample.profile.university} |
                                        <i class="bi bi-briefcase"></i> ${sample.industry} |
                                        <i class="bi bi-percent"></i> é¡ä¼¼åº¦: ${sample.similarity}%
                                    </small>
                                </div>
                                ${qaItemsHtml}
                            </div>
                        </div>
                    `;
                }).join('');

                // å¤§åˆ†é¡ä¸€è‡´ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                const matchInfoHtml = data.industrySimilarESSamples.exactMatch
                    ? ''
                    : `<div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle"></i> å¿—æœ›æ¥­ç•Œã®å®Œå…¨ä¸€è‡´ESãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€ã€Œ${data.industrySimilarESSamples.matchedCategory}ã€å¤§åˆ†é¡å†…ã®é¡ä¼¼ESã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                       </div>`;

                document.getElementById('industry-similar-es-section').innerHTML = `
                    <h5 class="text-primary mb-3"><i class="bi bi-file-earmark-text-fill"></i> å¿—æœ›æ¥­ç•Œå†…ã®é¡ä¼¼ES</h5>
                    ${matchInfoHtml}
                    ${industrySimilarESHtml}
                `;
            } else {
                // æ¥­ç•Œå†…ESãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                document.getElementById('industry-similar-es-section').innerHTML = `
                    <h5 class="text-primary mb-3"><i class="bi bi-file-earmark-text-fill"></i> å¿—æœ›æ¥­ç•Œå†…ã®é¡ä¼¼ES</h5>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> å¿—æœ›æ¥­ç•Œå†…ã®é¡ä¼¼ã™ã‚‹ESã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä»–ã®æ¥­ç•Œã®ESã¯ã€Œé¡ä¼¼ã™ã‚‹åˆæ ¼ESã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                    </div>
                `;
            }

            // ESåˆ†æ
            const strengthsHtml = data.esAnalysis.strengths.map(s =>
                `<li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> ${s}</li>`
            ).join('');
            document.getElementById('strengths-list').innerHTML = strengthsHtml;

            const improvementsHtml = data.esAnalysis.improvements.map(i =>
                `<li class="mb-2"><i class="bi bi-exclamation-triangle-fill text-warning"></i> ${i}</li>`
            ).join('');
            document.getElementById('improvements-list').innerHTML = improvementsHtml;

            document.getElementById('loading').classList.add('d-none');
            document.getElementById('results').classList.remove('d-none');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('diagnosis-form').reset();
            document.querySelectorAll('.answer-count').forEach(span => span.textContent = '0');
            document.getElementById('results').classList.add('d-none');
            document.getElementById('target-companies-section').classList.add('d-none');
            document.getElementById('form-section').classList.remove('d-none');

            const container = document.getElementById('es-questions-container');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            questionCount = 1;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSelects);
        } else {
            initializeSelects();
        }
    </script>
</body>
</html>
